name: Secret leak guard

on:
  workflow_call:
    inputs:
      fail-on-find:
        description: "Fail job if a likely secret is found"
        required: false
        type: boolean
        default: true
      scan-history:
        description: "Scan full git history (slower). If false, scan working tree only."
        required: false
        type: boolean
        default: false
      extra_args:
        description: "Extra args passed to gitleaks (e.g., --report-format sarif --report-path gitleaks.sarif)"
        required: false
        type: string
        default: ""
    secrets: {}

jobs:
  guard:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # only needed if you actually upload SARIF (public/GHAS)
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # 0 = full history (for scan-history), 1 = shallow for speed
          fetch-depth: ${{ inputs.scan-history && 0 || 1 }}

      - name: Run Gitleaks
        uses: zricethezav/gitleaks-action@v2
        with:
          args: >-
            detect --redact
            ${{ inputs.scan-history && '' || '--no-git -s .' }}
            --exit-code ${{ inputs.fail-on-find && '1' || '0' }}
            ${{ inputs.extra_args }}

      # Upload SARIF only if you asked Gitleaks to produce it in extra_args
      - name: Upload SARIF (public/GHAS only)
        if: >-
          ${{
            always()
            && github.event.repository.private == false
            && contains(inputs.extra_args, '--report-format sarif')
          }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif
